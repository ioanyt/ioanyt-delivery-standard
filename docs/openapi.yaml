openapi: 3.0.3
info:
  title: Usage Metrics API
  description: |
    A self-tracking API that records and reports usage metrics.

    This API demonstrates IOanyT's delivery standard - a reference implementation
    showing production-ready practices including comprehensive documentation,
    proper error handling, and observability.

    ## Features
    - Record usage events with metadata
    - Query events with filters and pagination
    - Get usage summaries and time-series data
    - Health and readiness endpoints for orchestration

    ## Authentication
    This reference implementation does not include authentication.
    Production deployments should add appropriate auth mechanisms.

    ## Rate Limiting
    No rate limiting in this reference. Production should implement
    appropriate limits based on your use case.
  version: 1.0.0
  contact:
    name: IOanyT Engineering
    email: engineering@ioanyt.com
    url: https://ioanyt.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:3000
    description: Local development
  - url: https://api-staging.example.com
    description: Staging environment
  - url: https://api.example.com
    description: Production environment

tags:
  - name: Health
    description: Health and readiness endpoints
  - name: Events
    description: Event recording and querying
  - name: Usage
    description: Usage analytics and reporting

paths:
  /health:
    get:
      tags:
        - Health
      summary: Liveness probe
      description: Returns OK if the service is running. Used by container orchestrators.
      operationId: getHealth
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: healthy
                timestamp: '2026-01-15T12:00:00.000Z'
                version: 1.0.0
                uptime: 3600

  /ready:
    get:
      tags:
        - Health
      summary: Readiness probe
      description: Returns OK if the service is ready to accept traffic. Checks dependencies.
      operationId: getReady
      responses:
        '200':
          description: Service is ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReadyResponse'
        '503':
          description: Service not ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReadyResponse'

  /v1/events:
    post:
      tags:
        - Events
      summary: Record a usage event
      description: Records a new usage event with the provided data.
      operationId: createEvent
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateEventRequest'
            example:
              entityId: user-123
              eventType: feature_used
              metadata:
                feature: dashboard
                duration: 30
      responses:
        '201':
          description: Event created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Event'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'

    get:
      tags:
        - Events
      summary: List events
      description: Returns events matching the specified filters with pagination.
      operationId: listEvents
      parameters:
        - name: entityId
          in: query
          description: Filter by entity ID
          schema:
            type: string
        - name: eventType
          in: query
          description: Filter by event type
          schema:
            type: string
        - name: startDate
          in: query
          description: Filter events after this date (ISO8601)
          schema:
            type: string
            format: date-time
        - name: endDate
          in: query
          description: Filter events before this date (ISO8601)
          schema:
            type: string
            format: date-time
        - name: limit
          in: query
          description: Maximum number of results (default 100, max 1000)
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
        - name: offset
          in: query
          description: Number of results to skip
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: List of events
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventListResponse'

  /v1/usage/{entityId}:
    get:
      tags:
        - Usage
      summary: Get usage summary
      description: Returns aggregated usage summary for a specific entity.
      operationId: getUsageSummary
      parameters:
        - name: entityId
          in: path
          required: true
          description: The entity ID to get usage for
          schema:
            type: string
      responses:
        '200':
          description: Usage summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UsageSummary'

  /v1/usage/{entityId}/history:
    get:
      tags:
        - Usage
      summary: Get usage history
      description: Returns time-series usage data for an entity.
      operationId: getUsageHistory
      parameters:
        - name: entityId
          in: path
          required: true
          description: The entity ID to get history for
          schema:
            type: string
        - name: granularity
          in: query
          description: Time bucket granularity
          schema:
            type: string
            enum: [hourly, daily]
            default: daily
        - name: startDate
          in: query
          description: Start of date range (ISO8601)
          schema:
            type: string
            format: date-time
        - name: endDate
          in: query
          description: End of date range (ISO8601)
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: Usage history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UsageHistory'

  /v1/usage/stats:
    get:
      tags:
        - Usage
      summary: Get overall statistics
      description: Returns system-wide usage statistics.
      operationId: getOverallStats
      responses:
        '200':
          description: Overall statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OverallStats'

components:
  schemas:
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [healthy]
        timestamp:
          type: string
          format: date-time
        version:
          type: string
        uptime:
          type: integer
          description: Uptime in seconds
      required:
        - status
        - timestamp

    ReadyResponse:
      type: object
      properties:
        status:
          type: string
          enum: [ready, not_ready]
        timestamp:
          type: string
          format: date-time
        checks:
          type: object
          additionalProperties:
            type: string
      required:
        - status
        - timestamp

    CreateEventRequest:
      type: object
      properties:
        entityId:
          type: string
          minLength: 1
          maxLength: 255
          pattern: '^[a-zA-Z0-9_-]+$'
          description: Unique identifier for the entity
        eventType:
          type: string
          minLength: 1
          maxLength: 100
          pattern: '^[a-zA-Z0-9_]+$'
          description: Type of event being recorded
        metadata:
          type: object
          additionalProperties: true
          description: Optional metadata for the event
      required:
        - entityId
        - eventType

    Event:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: Unique event identifier
        entityId:
          type: string
          description: Entity that generated the event
        eventType:
          type: string
          description: Type of event
        metadata:
          type: object
          additionalProperties: true
        timestamp:
          type: string
          format: date-time
          description: When the event was recorded
        traceId:
          type: string
          description: Request trace ID for correlation
      required:
        - id
        - entityId
        - eventType
        - timestamp

    EventListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Event'
        meta:
          type: object
          properties:
            total:
              type: integer
              description: Total matching events
            limit:
              type: integer
            offset:
              type: integer
          required:
            - total
            - limit
            - offset
      required:
        - data
        - meta

    UsageSummary:
      type: object
      properties:
        entityId:
          type: string
        totalEvents:
          type: integer
        uniqueEventTypes:
          type: integer
        firstSeen:
          type: string
          format: date-time
        lastSeen:
          type: string
          format: date-time
        eventTypes:
          type: object
          additionalProperties:
            type: integer
          description: Count per event type
      required:
        - entityId
        - totalEvents

    UsageHistory:
      type: object
      properties:
        entityId:
          type: string
        granularity:
          type: string
          enum: [hourly, daily]
        data:
          type: array
          items:
            type: object
            properties:
              period:
                type: string
                description: Time period (date or datetime)
              count:
                type: integer
            required:
              - period
              - count
      required:
        - entityId
        - granularity
        - data

    OverallStats:
      type: object
      properties:
        totalEvents:
          type: integer
        uniqueEntities:
          type: integer
        uniqueEventTypes:
          type: integer
        eventsPerDay:
          type: number
        oldestEvent:
          type: string
          format: date-time
        newestEvent:
          type: string
          format: date-time
      required:
        - totalEvents
        - uniqueEntities
        - uniqueEventTypes

    ValidationError:
      type: object
      properties:
        error:
          type: string
          example: Validation Error
        errors:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
              message:
                type: string
              value:
                type: string
            required:
              - field
              - message
      required:
        - error
        - errors

    Error:
      type: object
      properties:
        error:
          type: string
          description: Error message
        code:
          type: string
          description: Error code for programmatic handling
        traceId:
          type: string
          description: Trace ID for debugging
      required:
        - error
